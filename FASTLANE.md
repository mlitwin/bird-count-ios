# Fastlane: Build, Test, and TestFlight Upload

This project uses Fastlane + XcodeGen to generate the Xcode project, build, test, archive, and upload to TestFlight.

## Requirements

- Ruby + Bundler
- fastlane (installed via Bundler)
- XcodeGen (project is defined in `project.yml`)

Install tools:

```sh
bundle install
brew install xcodegen
```

## Lanes

- generate: Regenerates the Xcode project from `project.yml` using XcodeGen.
- build_sim: Builds the `BirdCount` scheme for the iOS Simulator (Debug).
- test_all: Runs macOS core tests (`BirdCountCore` on “My Mac”) and iOS tests (`BirdCount` on “iPhone 16”).
- archive: Archives the iOS app (`BirdCount` scheme, Release) and produces an IPA in `build/`.
- beta: Builds and uploads to TestFlight (Release). Uses automatic signing and `-allowProvisioningUpdates`.

## Authentication for TestFlight uploads

Preferred: App Store Connect API Key (non-interactive)

1) Create an API Key in App Store Connect (Users and Access → Keys) with role App Manager or Developer.
2) Provide credentials via environment variables before running the lane:

- APP_STORE_CONNECT_API_KEY_ID: Key ID (e.g. ABCDE12345)
- APP_STORE_CONNECT_ISSUER_ID: Issuer ID (UUID)
- One of:
	- APP_STORE_CONNECT_API_KEY_PATH: Path to AuthKey_<KEY_ID>.p8
	- APP_STORE_CONNECT_API_KEY_JSON: Path to JSON with key content
	- APP_STORE_CONNECT_API_KEY_BASE64: Base64 of .p8 contents

Fastlane will detect and use the API key automatically in the `beta` lane.

Fallback: Apple ID with app-specific password

- FASTLANE_USER: Your Apple ID email
- FASTLANE_PASSWORD: App-specific password (not your Apple ID password)
- FASTLANE_ITC_TEAM_ID or FASTLANE_ITC_TEAM_NAME: To select your App Store Connect team automatically

Team configuration

- Developer Portal Team (certs/profiles): set in `fastlane/Appfile` via `team_id` (10-char, currently 352K435X8J).
- App Store Connect Team: set `itc_team_id` or `itc_team_name` in `Appfile` to avoid prompts.

## Usage

From the repo root:

```sh
# List lanes
bundle exec fastlane lanes

# Generate Xcode project
bundle exec fastlane generate

# Build for simulator
bundle exec fastlane build_sim

# Run all tests (macOS + iOS)
bundle exec fastlane test_all

# Archive for distribution (outputs build/BirdCount.ipa)
DEVELOPMENT_TEAM_ID=352K435X8J bundle exec fastlane archive

# Upload to TestFlight with API Key auth
DEVELOPMENT_TEAM_ID=352K435X8J \
	APP_STORE_CONNECT_API_KEY_ID=YOUR_KEY_ID \
	APP_STORE_CONNECT_ISSUER_ID=YOUR_ISSUER_ID \
	APP_STORE_CONNECT_API_KEY_PATH=/secure/path/AuthKey_YOUR_KEY_ID.p8 \
	bundle exec fastlane beta
```

## Testflight users

```
op run --env-file apple.env --  fastlane pilot add mlitwin@sonic.net -g Birders
```

bundle exec fastlane spaceauth -u 
## Notes

- Schemes and deployment targets are defined in `project.yml` and generated by XcodeGen.
- If you see device name issues on CI, override with explicit destinations:
	- `scan(devices: ["Any Mac"])` for macOS
	- `scan(devices: ["iPhone 16"])` or `scan(destination: "platform=iOS Simulator,name=iPhone 16")` for iOS
- The `beta` lane enables automatic signing for the provided `DEVELOPMENT_TEAM_ID` and passes `-allowProvisioningUpdates` to let Xcode manage profiles.


Preferred: App Store Connect API Key (no prompts)
Create a key in App Store Connect (Users and Access → Keys) with App Manager or Developer.
Provide these env vars before running:
APP_STORE_CONNECT_API_KEY_ID
APP_STORE_CONNECT_ISSUER_ID
And one of: APP_STORE_CONNECT_API_KEY_PATH, APP_STORE_CONNECT_API_KEY_JSON, or APP_STORE_CONNECT_API_KEY_BASE64
With these set, upload_to_testflight will use the API key.


https://developer.1password.com/docs/cli/get-started/
`brew install 1password-cli`
op://<vault-name>/<item-name>/[section-name/]<field-name>
op://Private/MattDev_APIKEY/APP_STORE_CONNECT_API_KEY_ID
op://Private/MattDev_APIKEY/APP_STORE_CONNECT_ISSUER_ID
op://Private/MattDev_APIKEY/APP_STORE_CONNECT_API_KEY